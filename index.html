await customElements.whenDefined('openai-chatkit');

async function getClientSecret(existing) {
  const url = existing ? "/api/chatkit/refresh" : "/api/chatkit/start";
  const res = await fetch(url + (existing ? "" : "?reset=1"), {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: existing ? JSON.stringify({ currentClientSecret: existing }) : null
  });
  if (!res.ok) throw new Error(`Token ${res.status}: ${await res.text()}`);
  const { client_secret } = await res.json();
  return client_secret;
}

const chat = document.getElementById("chat");
chat.setOptions({
  api: { getClientSecret },
  locale: "es-ES"
});

// Logs de diagnóstico
chat.addEventListener('chatkit.ready',  () => console.log('✅ chatkit.ready'));
chat.addEventListener('chatkit.error',  e => console.error('❌ chatkit.error', e.detail || e));
chat.addEventListener('chatkit.state',  e => console.log('ℹ️ state', e.detail));
