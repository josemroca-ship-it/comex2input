<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>AI Megafy - COMEX2</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- ChatKit -->
  <script src="https://cdn.platform.openai.com/deployments/chatkit/chatkit.js" defer></script>

  <style>
    :root {
      --w: 1000px;
      --header-bg: linear-gradient(180deg, #0b1b2f 0%, #0a1422 100%);
      --text-light: #e8eef7;
      --text-dark: #222;
      --muted: #6b7583;
      --accent: #4cc2ff;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: #fff;              /* fondo blanco global */
      color: var(--text-dark);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 32px;
      padding: 0 24px 40px;
      min-height: 100vh;
    }

    /* ===== Encabezado oscuro con FADE hacia blanco ===== */
    header {
      width: 100%;
      background: var(--header-bg);
      color: var(--text-light);
      display: flex;
      justify-content: center;
      padding: 24px 0 48px;  /* un poco más de padding inferior para lucir el fade */
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      position: relative;     /* para posicionar el pseudo-elemento */
      overflow: visible;
      isolation: isolate;     /* asegura mezcla correcta del fade */
    }
    header::after {
      content: "";
      position: absolute;
      left: 0; right: 0; bottom: -40px;
      height: 80px;
      pointer-events: none;
      background: linear-gradient(
        to bottom,
        rgba(10, 20, 34, 0.85) 0%,
        rgba(10, 20, 34, 0.35) 35%,
        rgba(10, 20, 34, 0.12) 60%,
        rgba(10, 20, 34, 0.00) 100%
      );
      opacity: 0;
      transform: translateY(8px);
      animation: fadeDown 600ms ease-out forwards 80ms;
    }
    @keyframes fadeDown {
      to { opacity: 1; transform: translateY(0); }
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 14px;
      max-width: var(--w);
      padding: 0 16px;
    }
    .brand img { height: 46px; filter: drop-shadow(0 2px 6px rgba(0,0,0,0.4)); }
    .brand h1 { font-size: 1.4rem; font-weight: 600; }
    .sub { font-size: 0.95rem; color: #c3cde0; }

    /* Tarjeta del chat */
    .card {
      width: 100%;
      max-width: var(--w);
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      border: 1px solid #eee;
      padding: 24px;
      margin-top: -16px;  /* solapa bajo el fade para continuidad */
      position: relative;
      z-index: 0;
    }
    .card-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      border-bottom: 1px solid #eee;
      padding-bottom: 8px;
    }
    .status {
      font-size: 0.9rem;
      color: #2e7d32;
      font-weight: 500;
    }
    .status .dot {
      width: 10px; height: 10px;
      display: inline-block;
      border-radius: 50%;
      margin-right: 6px;
      background: #2e7d32;
      box-shadow: 0 0 6px #2e7d32aa;
    }
    .badge {
      font-size: 0.8rem;
      background: var(--accent);
      color: #00233f;
      padding: 4px 10px;
      border-radius: 999px;
      font-weight: 600;
    }

    /* Host del ChatKit embebido */
    openai-chatkit {
      display: block;
      width: 100%;
      height: clamp(520px, 70vh, 720px);
      border-radius: 10px;
      border: 1px solid #ddd;
      background: #fafafa;
    }

    /* Bloque de subida guiado */
    #uploadBlock {
      display: none;
      margin-top: 12px;
      border: 1px solid #eee;
      border-radius: 10px;
      padding: 12px;
      background: #f9fbff;
    }
    #uploadBlock .title {
      font-weight: 600; margin-bottom: 6px;
    }
    #uploadForm {
      display: flex; gap: 8px; align-items: center; flex-wrap: wrap;
    }
    #uploadForm input[type="file"] {
      border: 1px solid #dbe7ff; border-radius: 8px; padding: 6px; background: #fff;
    }
    #btnUpload, #btnCopy {
      padding: 8px 12px; border-radius: 10px; border: 1px solid #dbe7ff; cursor: pointer;
      background: #0f66ff; color: #fff; font-weight: 600;
    }
    #btnCopy { background: #eef5ff; color: #0a2440; }
    #uploadResult { margin-top: 8px; font-size: 14px; color: #0a2440; }
    #fileTagRow { display: none; margin-top: 8px; }
    #fileTag {
      width: 100%; padding: 8px; border: 1px solid #dbe7ff; border-radius: 8px; background: #fff;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    }

    footer {
      text-align: center;
      font-size: 0.9rem;
      color: var(--muted);
    }

    @media (max-width: 560px) {
      .brand h1 { font-size: 1.15rem; }
      .sub { font-size: 0.85rem; }
      .card { padding: 16px; }
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <img src="https://megafy.net/wp-content/uploads/2022/06/logo-megafy-footer.png" alt="Logo Megafy" />
      <div>
        <h1>AI Megafy - COMEX</h1>
        <div class="sub">Tu copiloto inteligente, 24/7</div>
        <!-- Si quieres, aquí podrías añadir un botón a Hosted Chat en el futuro -->
      </div>
    </div>
  </header>

  <div class="card">
    <div class="card-head">
      <div class="status"><span class="dot"></span>Disponible</div>
      <div class="badge">Beta</div>
    </div>

    <!-- Chat embebido -->
    <openai-chatkit id="chat"></openai-chatkit>

    <!-- Bloque de subida (oculto hasta que el asistente lo pida con [[UPLOAD_REQUIRED]]) -->
    <div id="uploadBlock">
      <div class="title">Subir PDF solicitado por el asistente</div>
      <form id="uploadForm">
        <input id="pdfInput" type="file" accept="application/pdf" />
        <button id="btnUpload" type="submit">Subir PDF</button>
      </form>
      <div id="uploadResult"></div>
      <div id="fileTagRow">
        <input id="fileTag" readonly />
        <button id="btnCopy">Copiar y pegar en el chat</button>
        <div style="font-size:12px; color:#555; margin-top:6px">
          Pega ese texto en el cuadro del chat y envíalo para continuar el flujo.
        </div>
      </div>
    </div>
  </div>

  <footer>Desarrollado con 🧠 x Megafy</footer>

  <script type="module">
    await customElements.whenDefined('openai-chatkit');

    // Token para el widget
    async function getClientSecret(existing) {
      const url = existing ? "/api/chatkit/refresh" : "/api/chatkit/start";
      const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: existing ? JSON.stringify({ currentClientSecret: existing }) : null
      });
      if (!res.ok) throw new Error(`Token ${res.status}: ${await res.text()}`);
      const { client_secret } = await res.json();
      if (!client_secret) throw new Error("Sin client_secret");
      return client_secret;
    }

    const chat = document.getElementById("chat");
    chat.setOptions({
      api: { getClientSecret },
      locale: "es-ES"
    });

    /* ===== Lógica de subida paso-guiado ===== */

    // Referencias UI
    const uploadBlock  = document.getElementById('uploadBlock');
    const uploadForm   = document.getElementById('uploadForm');
    const pdfInput     = document.getElementById('pdfInput');
    const uploadResult = document.getElementById('uploadResult');
    const fileTagRow   = document.getElementById('fileTagRow');
    const fileTagInput = document.getElementById('fileTag');
    const btnCopy      = document.getElementById('btnCopy');

    // 1) Mostrar/ocultar uploader según el MENSAJE del asistente
    //    Requiere que el mensaje del agente incluya [[UPLOAD_REQUIRED]]
    chat.addEventListener('chatkit.state', (evt) => {
      try {
        const messages = evt.detail?.messages || [];
        const last = [...messages].reverse().find(m => m?.role === 'assistant' && typeof m?.content === 'string');
        if (!last) return;
        const needsUpload = last.content.includes('[[UPLOAD_REQUIRED]]');
        uploadBlock.style.display = needsUpload ? 'block' : 'none';
        if (!needsUpload) {
          uploadResult.textContent = '';
          fileTagRow.style.display = 'none';
          fileTagInput.value = '';
          pdfInput.value = '';
        }
      } catch {}
    });

    // 2) Subir PDF a tu backend (/api/upload)
    uploadForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const f = pdfInput.files?.[0];
      if (!f) { uploadResult.textContent = 'Selecciona un PDF.'; return; }
      uploadResult.textContent = 'Subiendo PDF…';
      fileTagRow.style.display = 'none';

      const fd = new FormData();
      fd.append('file', f);
      try {
        const r = await fetch('/api/upload', { method:'POST', body: fd });
        if (!r.ok) {
          uploadResult.textContent = `Error al subir: ${await r.text()}`;
          return;
        }
        const { file_id, name } = await r.json();
        uploadResult.textContent = `PDF "${name || f.name}" subido correctamente.`;
        // 3) Genera el tag para pegar en el chat
        const tag = `[[FILE:${file_id}]]`;
        fileTagInput.value = tag;
        fileTagRow.style.display = 'block';
      } catch (err) {
        uploadResult.textContent = `Error de red: ${err?.message || err}`;
      }
    });

    // 3) Copiar el tag al portapapeles
    btnCopy.addEventListener('click', async (e) => {
      e.preventDefault();
      if (!fileTagInput.value) return;
      try {
        await navigator.clipboard.writeText(fileTagInput.value);
        btnCopy.textContent = '¡Copiado! Pega en el chat y envía';
        setTimeout(()=> btnCopy.textContent = 'Copiar y pegar en el chat', 2000);
      } catch {
        fileTagInput.select(); document.execCommand('copy');
      }
    });

    // (Opcional) logs por consola
    chat.addEventListener('chatkit.ready', () => console.log('✅ chatkit.ready'));
    chat.addEventListener('chatkit.error', (e) => console.error('❌ chatkit.error', e.detail || e));
  </script>
</body>
</html>
